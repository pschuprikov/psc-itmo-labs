\section{Построение береговых координат}
Результатом данной главы станет некоторое непрерывное отображение точки $(x,y)$ в мировой системе координат (игнорируя высоту) в пару вещественных значений $(\mathrm{TC}_x, \mathrm{TC}_y)$, которые мы далее будем называть береговыми координатами:
\begin{equation}\label{base_tc}
 (\mathrm{TC}_x, \mathrm{TC}_y) = f(x, y)
\end{equation}

При этом изолинии $\mathrm{TC}_y = \mathrm{const}$ должны быть визуально 
похожи на множество точек, расположенных на одном расстоянии от береговой линии и для определенность пусть значение $\mathrm{TC}_y$ будет убывать при приближении к берегу со стороны моря. Таким образом, если параметром эффекта является некоторая функция береговых координат 
$g(\mathrm{TC}_x. \mathrm{TC}_y)$, то для получения того же самого эффекта, движущегося к берегу со скоростью $v$, достаточно следующим образом изменить параметризацию: 
\begin{equation}
g'(\mathrm{TC}_x. \mathrm{TC}_y) = g(\mathrm{TC}_x, \mathrm{TC}_y + v t),
\end{equation}
где $t$ --- время.

\subsection{Кусочно-линейный скелет}
В данном методе используется метод представления полигона (береговая линия также является полигоном),
известный как \emph{кусочно-линейный скелет} (англ.~Straight Skeleton). 
С помощью кусочно-линейного скелета можно быстро получить заданное \emph{смещение} заданного полигона.
Более формальное определение операции смещения будет дано далее.

Определим кусочно-линейный скелет так, как это сделано в \cite{skeleton_theory}.
Предположим, что дан некоторый полигон, тогда рассмотрим здание, 
представляющее собой прямоугольную призму с основанием, границей которого является имеющийся полигон. 
Далее рассмотрим структуру крыши этого здания, если наклон крыши всюду один и тот же 
(см.~рис.~\ref{fig_skeleton_roof}).
Оказывается, что структура получившейся крыши не зависит от величины наклона, а
полученное множество ребер и вершин крыши, спроецированное на плоскость основания,
является кусочно-линейным скелетом исходного полигона.

\drawfigurex{H}{width=10cm}{pics/skeleton.eps}{Кусочно-линейный скелет как <<крыша>>
с фиксированным углом наклона над полигональным основанием}{fig_skeleton_roof}

\emph{Смещение полигона} на величину $\mathrm{offset} \le 0$, определим следующим образом:
пусть наклон крыши составляет $\alpha$ радиан, тогда рассмотрим сечение крыши, параллельное 
основанию и расположенное на высоте $$h = (\mathrm{-offset}) \cdot \tan{\alpha},$$ относительно него. 
Проекция данного сечения на плоскость основания и является смещением. Заметим, что 
смещение полигона, в общем случае, может представлять собой множество полигонов или вовсе быть пустым.
Если продолжить крышу <<вниз>> относительно основания, то аналогичным образом определяется
смещение полигона на величину $\mathrm{offset} > 0$. Смещения полигона изображены серыми 
линиями на рис.~\ref{fig_skeleton_roof}.

\subsection{Береговые координаты на основе кусочно-линейной функции}
В данном подразделе вводиться система координат, основанная на смещениях полигона. При этом считается
, что рассматриваемые смещения полигона береговой линии остаются связными без пересечений. 
В процессе рассматривается несколько возможных способов задать координаты $(\mathrm{TC}_x, \mathrm{TC}_y)$,
итеративно улучшая предыдущий результат.
Итак, через некоторую точку $(x,y)$ (см.~рис.~\ref{fig_skeleton_base}) проходит не более 
чем одно связное смещение полигона береговой линии. Если данное смещение $l(y_0)$ на величину $y_0$
 существует, то определим береговые координат $(\mathrm{TC}_x, \mathrm{TC}_y)$ следующим образом:
\begin{equation}\label{tc_first}
    (\mathrm{TC}_x(x,y), \mathrm{TC}_y(x,y)) = (x_{y_0}, y_0),
\end{equation}
где $x_{y_0}$ --- длина подотрезка $l(y_0)$ от некоторого положения $\mathrm{TC}_x = 0$ до точки $(x,y)$ 
(см.~рис.~\ref{fig_skeleton_roof}).

\drawfigure{pics/skeleton_base.eps}{Береговая система координат без сглаживания. Красным и синим
выделены береговая линия ($y = 0$) и множество, на котором $x = 0$, соответственно; 
пунктиром обозначены ребра кусочно-линейного скелета; $l(y_o)$ и $l(y_1)$ --- смещения полигона береговой 
линии на величины $y_0$ и $y_1$ соответственно.}{fig_skeleton_base}

\subsection{Интерполяция координат}
Для работы методов, приведенных в следующем разделе и отвечающих за нанесение разрабатываемых 
эффектов на поверхность воды, необходима возможность быстро восстанавливать координаты
$(\mathrm{TC}_x,\mathrm{TC}_y)$, зная $(x,y)$. Пусть здесь и далее $\mathrm{maxOffset}$ --- максимальная
величина смещения полигона, а $\mathrm{minOffset}$ --- минимальная (допускается $\mathrm{minOffset} < 0$), 
и пусть имеется некоторое представление кусочно-линейного скелета, <<покрывающее>> эти границы смещений.

\subsubsection{Разбиение кусочно-линейного скелета}
Грани кусочно линейного скелета разбиваются на четырехугольники и треугольники, внутри которых формула
выражающая зависимость $\vec{\mathrm{TC}} = f(\bvec{x})$ имеет простой вид. Каждая грань 
$\bvec{v}_0\bvec{v}_1 \ldots \bvec{v}_n$ 
,где $\bvec{v}_0\bvec{v}_1$ --- ребро исходного полигона, кусочно-линейного скелета подразбивается 
на трапеции следующим образом:
\begin{enumerate}
\item Строится множество $Y= \{y_i\} = \bigcup\limits_{i=0}^n \{\mathrm{distance}(\bvec{v}_0, l)\}$, где $l$ -- прямая, 
проходящая через $\bvec{v}_0$ и $\bvec{v}_1$.
\item Исходная грань $\bvec{v}_0\bvec{v}_1 \ldots \bvec{v}_n$ разбивается прямыми $l_i$, параллельными $l$, 
находящимися на расстоянии $y_i$ от $l$. Элементом разбиения являются либо трапеции, основания которых
параллельны $l$, либо треугольник, одна из сторон которого также параллельна $l$.
\end{enumerate}

\subsubsection{Оценка размера разбиения}
Заметим, что согласно \cite{skeleton_theory} кусочно-линейный скелет, построенный для 
внутренней части полигона с $n$ вершинами, содержит $2 n - 2$ вершины (включая вершины полигона).
Аналогичная оценка верна и для внешней части, если считать, что каждому бесконечному ребру скелета 
соответствует своя вымышленная вершина на бесконечности. Таким образом общее число вершин можно ограничить
как $3 n$. Заметим, что через каждую вершину в процессе разбиения будет проведено не более двух прямых, а
значит число трапеций можно ограничить как $6n = O(n)$.

Пусть имеется точка $(x,y)$ и требуется найти соответствующие ей координаты 
$(\mathrm{TC}_x, \mathrm{TC}_y)$, если точка лежит внутри трапеции, иначе нужно сказать, что точка
не лежит в данной трапеции. Случай треугольника является частным случаем трапеции, поэтому он
рассмотрен не будет. Дальнейшие формулы будут использовать грань $bckl$ кусочно линейного скелета 
с рис.~\ref{fig_skeleton_base}, а также рис.~\ref{fig_skeleton_interpolation}. 
Обозначим за $(\mathrm{TC}_x^p, \mathrm{TC}_y^p)$ береговые координаты в точке $\bvec{p}$.

\drawfigure{pics/skeleton_interpolation.eps}{Подразбиение грани $bckl$ на трапецию и треугольник для
быстрого определения береговых координат $(\mathrm{TC}_x,\mathrm{TC}_y)$, соответствующих точке $(x,y)$.}
{fig_skeleton_interpolation}

\subsubsection{Вычисление координат внутри трапеции}
Рассмотрим теперь процесс вычисления координат $\bvec{x} = (\mathrm{TC}_x,\mathrm{TC}_y)$ внутри трапеции
$bmkc$:
\begin{enumerate}
\item Вычислим нормализованную вертикальную координату внутри трапеции:
\begin{equation}
u_n = (\bvec{x} - \bvec{m}) \cdot \bvec{u} / (\mathrm{TC}_y^m - \mathrm{TC}_y^b).
\end{equation}
Если $u_n \notin [0,1]$, то точка не лежит внутри трапеции.
\item Определим отрезок, параллельный $\bvec{b}\bvec{c}$, проходящий через $\bvec{x}$:
\begin{equation}
\begin{array}{c}
\bvec{p} =  (1 - u_n) \bvec{m} + u_n \bvec{b} \\
\bvec{p'} = (1 - u_n) \bvec{k} + u_n \bvec{c}.
\end{array}
\end{equation}
\item Вычислим нормализованную горизонтальную координату внутри трапеции:
\begin{equation}
s_n = \frac{(\bvec{x} - \bvec{p}) \cdot \bvec{s}}{||\bvec{p} - \bvec{p'}||}.
\end{equation}

Если $s_n \notin [0,1]$ то точка не лежит внутри трапеции.
\item Линейно интерполируем $\mathrm{TC}_x$ на отрезок $\bvec{p}\bvec{p'}$:
\begin{equation}
\begin{array}{c}
\mathrm{TC}_x^p = (1 - u_n) \mathrm{TC}_x^m + u_n \mathrm{TC}_x^b \\
\mathrm{TC}_x^{p'} = (1 - u_n) \mathrm{TC}_x^k + u_n \mathrm{TC}_x^k.
\end{array}
\end{equation}
\item $(\mathrm{TC}_x, \mathrm{TC}_y) = ((1 - s_n) \mathrm{TC}_x^p + s_n\mathrm{TC}_x^{p'}, (1 - u_n) \mathrm{TC}_y^m + u_n \mathrm{TC}_y^b)$.
\end{enumerate}

\subsection{2}
Координаты, предложенные в предыдущих подразделах обладают существенным недостатком: изолиния 
$x_c = \mathrm{const}$ представляет собой ломаную и любой накладываемый эффект будет 
повторять вид этой ломаной. Для решения данной проблемы применяется интерполяция сплайнами, 
часто применяемая для сглаживания изолиний, а именно сплайн \emph{Catmull-Rom}. 
Пусть имеется некоторая  полилиния и ${\mathbf{p_0}, \mathbf{p_1}, \mathbf{p_2}, \mathbf{p_3}}$ некоторые последовательные ее точки,
тогда для интерполяции на отрезке $\mathbf{p_1}\mathbf{p_2}$ используется приближение производной кривой 
сплайна в точках $\mathbf{p_1}$ и $\mathbf{p_2}$, вычисленное как:
$$
    \mathbf{p'_1} = \frac{\mathbf{p_2} - \mathbf{p_0}}{||\mathbf{p_2} - \mathbf{p_1}|| + ||\mathbf{p_1} - \mathbf{p_0}||}
$$

$$
    \mathbf{p'_2} = \frac{\mathbf{p_3} - \mathbf{p_1}}{||\mathbf{p_3} - \mathbf{p_2}|| + ||\mathbf{p_2} - \mathbf{p_1}||}
$$

Затем вводится параметр $t \in [0,1]$, и интерполированное значение вычисляются по следующей формуле:

\begin{equation}\label{spline}
    \mathbf{p}(t) = (2 t^3 - 3 t^2 + 1)\mathbf{p_1} + (t^3 - 2 t^2 + t) \mathbf{p'_1} + 
    (-2 t^3 + 3 t^2)\mathbf{p_2} + (t^3 - t^2) \mathbf{p'_2}.
\end{equation}

На этапе предварительной обработки для каждой вершины $\mathbf{p}$ трапеции рассчитывается приближение 
производной $\mathbf{p'}$. Через точку $\mathbf{q}$ трапеции можно провести отрезок $\mathbf{q_1}\mathbf{q_2}$, пересекающий обе боковые 
грани, пускай в точках $\mathbf{q_1}$ и $\mathbf{q_2}$ соответствующее интерполированное значение производной равняются 
$\mathbf{q'_1}$ и $\mathbf{q'_2}$, тогда вычислим параметр $t = ||\mathbf{q} - \mathbf{q_1}|| / ||\mathbf{q_2} - \mathbf{q_1}||$, 
используя его вычислим интерполированную точку сплайна $\mathbf{q_s}(t)$ по формуле \ref{spline}.

Интерполированные без использование сплайна береговые координаты точки $\mathbf{q}$
далее модифицируются следующим образом:
\begin{equation}
(x_c, y_c) \rightarrow (x_c, y_c - (\mathbf{qs} - \mathbf{q_1}) \cdot \mathbf{up_n}),
\end{equation}
где $\mathbf{up_n}$ --- вектор, перпендикулярный $\mathbf{q_1}\mathbf{q_2}$, направленный к 
берегу.

Эксперимент показал, что полученные координаты достаточно хорошо соответствуют исходному сплайну.

\subsection{Отражение координат}
Последняя коррекция координат вызвана тем, что длины изолиний на разных смещениях разные, поэтому 
по координате $x_c$ неизбежно будет накапливаться сдвиг. Чтобы решить данную проблему, координаты $x_c$
отражаются через некоторый фиксированный интервал, благодаря чему удается сохранить непрерывность поля
координат и сохранить направленность градиента $(x_c, y_c)$ к берегу.
