\section{Построение береговых координат}
Результатом данной главы станет некоторое непрерывное отображение точки $(x,y)$ в мировой системе координат (игнорируя высоту) в пару вещественных значений $(\mathrm{TC}_x, \mathrm{TC}_y)$, которые мы далее будем называть береговыми координатами:
\begin{equation}\label{base_tc}
 (\mathrm{TC}_x, \mathrm{TC}_y) = f(x, y)
\end{equation}

При этом изолинии $\mathrm{TC}_y = \mathrm{const}$ должны быть визуально 
похожи на множество точек, расположенных на одном расстоянии от береговой линии и для определенность пусть значение $\mathrm{TC}_y$ будет убывать при приближении к берегу со стороны моря. Таким образом, если параметром эффекта является некоторая функция береговых координат 
$g(\mathrm{TC}_x. \mathrm{TC}_y)$, то для получения того же самого эффекта, движущегося к берегу со скоростью $v$, достаточно следующим образом изменить параметризацию: 
\begin{equation}
g'(\mathrm{TC}_x. \mathrm{TC}_y) = g(\mathrm{TC}_x, \mathrm{TC}_y + v t),
\end{equation}
где $t$ --- время.

\subsection{Кусочно-линейный скелет}
В данном методе используется такой метод представления полигонов, которым является
береговая линия, известный как \emph{кусочно-линейный скелет} (англ.~Straight Skeleton). Данное представление позволяет получить полигон с заданным отступом от исходного, менее неформальное описание которого будет дано далее. Стоит сказать, что
полученный полигон является визуально приемлемой альтернативой множеству точек, расположенных на заданном расстоянии от исходного полигона, в то время, как последнее
имеет значительно более сложную структуру.

Неформально опишем кусочно-линейный скелет. Предположим, что у нас имеется некоторое здание, представляющий собой прямоугольную призму с основанием, границей которого является некоторый полигон. Пусть далее мы решили выяснить как выглядит крыша это здания, если наклон крыши всюду один и тот же. 
Оказывается, что множество ребер получившейся крыши не зависит от величины наклона. Данное множество 
ребер и множество граней крыши и является рассматриваемой структурой данных. 

Смещение полигона на величину $\1mathrm{offset} > 0$ получается следующим образом: поочередно 
проходим по всем граням \emph{Straight Skeleton}-а, в каждой грани находим точки, 
находящихся на расстоянии $\mathrm{offset}$ от основания грани (граница основания здания). Можно показать, что грани 
всегда будут выпуклыми многоугольниками, поэтому либо таких точек будет:
\begin{enumerate}
\item ни одной;
\item ровно две;
\item ровно одна (она является единственной наиболее удаленной точкой грани);
\item бесконечно много, и этот случай мы не рассматривать не будем, считая его границей
применимости данного метода. Этот случай связан со смещением, приводящим к <<схлопыванию>> 
бухт на контуре береговой линии.
\end{enumerate}

Пусть через точку $(x, y)$ проходит полигон, смещенный на $\mathrm{offset}$, тогда
координатой $y_c$ будет служить почти $\mathrm{offset}$, а координатой
$x_c$ --- почти длина вдоль смещенного полигона до заданной точки. <<Почти>> будет 
исправлено далее.

\subsection{Интерполяция координат}
Для того, чтобы вычислить значение координат в любой точке трехмерной сцены используя
необходимо интерполировать значение координат из вершин трапеций в любую ее внутреннюю точку.
Для использования линейной интерполяции весь полигон разбивается на протяженные части, 
включающие порядка тысячи отрезков, с каждой из которых будем далее работать отдельно.

Для полилинии, являющейся подмножеством полигона береговой линии $l(0)$, анализируется
\emph{Straight Skeleton} и строится некоторое множество смещенных полилиний ${l(o_0), l_(o_1), \ldots}$,
причем множество оффсетов ${o_i}$ выбирается следующим образом: для каждой вершины скелетона 
вычисляется расстояние до всех граней, которым принадлежит данная вершина и каждое из этих расстояний
добавляется в множество ${o_i}$. Получившееся множество полилиний разбивает скелетон на трапеции, 
причем каждая параллельная грань трапеций соответствуют какому-то отрезку какого-то смещения $l(0)$.

Координаты $(x_c,y_c)$ линейно интерполированные из вершин трапеций в любую другую точку трапеции
будут корректным значением $(x'_c, y'_c)$ в данной точке.

\subsection{Ломаные изолинии. Интерполяция сплайнами}
Координаты, предложенные в предыдущих подразделах обладают существенным недостатком: изолиния 
$x_c = \mathrm{const}$ представляет собой ломаную и любой накладываемый эффект будет 
повторять вид этой ломаной. Для решения данной проблемы применяется интерполяция сплайнами, 
часто применяемая для сглаживания изолиний, а именно сплайн \emph{Catmull-Rom}. 
Пусть имеется некоторая  полилиния и ${\mathbf{p_0}, \mathbf{p_1}, \mathbf{p_2}, \mathbf{p_3}}$ некоторые последовательные ее точки,
тогда для интерполяции на отрезке $\mathbf{p_1}\mathbf{p_2}$ используется приближение производной кривой 
сплайна в точках $\mathbf{p_1}$ и $\mathbf{p_2}$, вычисленное как:
$$
    \mathbf{p'_1} = \frac{\mathbf{p_2} - \mathbf{p_0}}{||\mathbf{p_2} - \mathbf{p_1}|| + ||\mathbf{p_1} - \mathbf{p_0}||}
$$

$$
    \mathbf{p'_2} = \frac{\mathbf{p_3} - \mathbf{p_1}}{||\mathbf{p_3} - \mathbf{p_2}|| + ||\mathbf{p_2} - \mathbf{p_1}||}
$$

Затем вводится параметр $t \in [0,1]$, и интерполированное значение вычисляются по следующей формуле:

\begin{equation}\label{spline}
    \mathbf{p}(t) = (2 t^3 - 3 t^2 + 1)\mathbf{p_1} + (t^3 - 2 t^2 + t) \mathbf{p'_1} + 
    (-2 t^3 + 3 t^2)\mathbf{p_2} + (t^3 - t^2) \mathbf{p'_2}.
\end{equation}

На этапе предварительной обработки для каждой вершины $\mathbf{p}$ трапеции рассчитывается приближение 
производной $\mathbf{p'}$. Через точку $\mathbf{q}$ трапеции можно провести отрезок $\mathbf{q_1}\mathbf{q_2}$, пересекающий обе боковые 
грани, пускай в точках $\mathbf{q_1}$ и $\mathbf{q_2}$ соответствующее интерполированное значение производной равняются 
$\mathbf{q'_1}$ и $\mathbf{q'_2}$, тогда вычислим параметр $t = ||\mathbf{q} - \mathbf{q_1}|| / ||\mathbf{q_2} - \mathbf{q_1}||$, 
используя его вычислим интерполированную точку сплайна $\mathbf{q_s}(t)$ по формуле \ref{spline}.

Интерполированные без использование сплайна береговые координаты точки $\mathbf{q}$
далее модифицируются следующим образом:
\begin{equation}
(x_c, y_c) \rightarrow (x_c, y_c - (\mathbf{qs} - \mathbf{q_1}) \cdot \mathbf{up_n}),
\end{equation}
где $mathbf{up_n}$ --- вектор, перпендикулярный $\mathbf{q_1}\mathbf{q_2}$, направленный к 
берегу.

Эксперимент показал, что полученные координаты достаточно хорошо соответствуют исходному сплайну.

\subsection{Отражение координат}
Последняя коррекция координат вызвана тем, что длины изолиний на разных смещениях разные, поэтому 
по координате $x_c$ неизбежно будет накапливаться сдвиг. Чтобы решить данную проблему, координаты $x_c$
отражаются через некоторый фиксированный интервал, благодаря чему удается сохранить непрерывность поля
координат и сохранить направленность градиента $(x_c, y_c)$ к берегу.
