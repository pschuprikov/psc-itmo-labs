\section{Набег волны на берег. Эффект <<Мокрого песка>>}\label{shoreline}

\subsection{Вода на берегу}\label{water_shore}
В результате набега волны, определенный объем воды необходимо выплескивается на берег, что
приводит, во-первых, к изменению геометрии водной поверхности, во-вторых, к изменению отражающих
характеристик прибрежного песка. Имеющаяся реализация визуализацию водной поверхности 
никак не учитывает набегающие волны, и необходимо было разработать метод, удовлетворяющий 
постановке задачи и исправляющий данный недостаток.

В качестве одной из альтернатив рассматривался метод, предложенный в работе \cite{skyforge},
который осуществлял выравнивание геометрии воды поверх ландшафта, таким образом ответственность за
обозначенный эффект переходила на механизм визуализации воды, который соответствующим образом 
модифицировался.Данный метод был отвергнут по следующим причинам:
\begin{itemize}
\item Модификация системы визуализации водной поверхности нежелательна.
\item Информация о береговых координатах может быть передана механизму визуализации водной 
поверхности только с использованием каких-то дополнительных структур 
(например, ортографической текстуры), что требует дополнительных расходов по памяти.
\end{itemize}

В данной работе решено было использовать метод на основе объемных наклеек, представленный в разделе (\ref{volume_decals}), 
только продублировав в нем весь существующий механизм визуализации водной поверхности. 
Данный метод лишен недостатков, перечисленных ранее, и позволяет реализовать 
визуализацию водной поверхности на берегу одновременно с эффектом прибрежной пены.

\subsection{Пересечении фронтом волны береговой линии}
Детали рассматриваемые в данном подразделе интенсивно используют введенные в разделе (\ref{trains})
обозначения. Характер движения линии фронта, при пересечении им береговой линии, сменяется с 
равномерного со скоростью $v$ на равноускоренное, при этом ускорение направлено с берега в воду.
Таким образом накатив на берег, фронт скатывается обратно, при этом значение $\gamma$ на точках
этого фронта постепенно уменьшается до нуля. 

Пусть оказалось, что некоторая точка $\bvec{x} = (x, y)$ с береговыми координатами 
$(\mathrm{TC}_x, \mathrm{TC}_y)$ в результате вычислений, представленных в 
предыдущем разделе, определила координаты $(\mathrm{TC}_x, a_y)$ последний раз
прошедшего через нее фронта. Пусть также оказалось, что знаковое расстояние 
$$
d = a_y  - \mathrm{TC}_y + \mathrm{TC}_y^{0},
$$
где $\mathrm{TC}_y^{0}$ --- не модифицированная сплайном интерполированная береговая
$y$-координата, оказалось меньше нуля, т. е. фронт пересек береговую линию. 
Тогда время, прошедшее с момента, пересечения фронтом береговой линии. рассчитывается
как $t_\mathrm{coast} = |d| / v$. Далее вычисляется новое положение $\tilde{a}_y$ фронта, 
исходя из следующих вычислений:
\begin{itemize}
\item $v_0 = \mathrm{mix}(v, v_\mathrm{min}, \mathrm{noise}_{\mathrm{lf}}(\mathrm{tid}, \mathrm{TC}_x)$ --- предполагаемая 
начальная скорость фронта в момент пересечения им береговой линии, различная для различных полос
и использующая некоторый низкочастотный шум.
\item $a = v_0 / \mathrm{\Delta t}$ --- ускорение фронта, направленное обратно с берега в воду.
$\mathrm{\Delta t}$ --- время жизни пены, порожденной данным фронтом.
\item новое положение фронта вычисляется как: 
\begin{equation}\label{shore_front}
\tilde{a}_y = v_0 \tilde{t} - \frac{a \tilde{t}^2}{2},
\end{equation}
где $\tilde{t} = min(\mathrm{\Delta t}, t)$.
\end{itemize}
Значение $\gamma$ при этом каким-либо образом уменьшается при приближении $t$ к $\mathrm{\Delta t}$.

\subsection{Накат волны на берег}
Используя приемы из подраздела (\ref{water_shore}), осуществляется новый запуск визуализации, 
задача которой реализовать эффект наката/отката прибрежной волны. 
Запуск состоит из следующих этапов:
\begin{enumerate}
\item \b{Метод объемных наклеек.} На поверхности берега, потенциально подверженной накату волны, с помощью модификации метода 
объемных наклеек (см.~\ref{volume_decals}), рассчитывались мировые координаты $(x, y, z)$ и береговые 
координаты $(\mathrm{TC}_x, \mathrm{TC}_y)$ соответствующие обрабатываемому фрагменту изображения.
\item \b{Эффект пены. Отмена фрагментов.}Вычисляются параметры эффекта прибоя с учетом равноускоренного наката/отката. 
Фрагменты, соответствующие поверхности ландшафта берегу и расположенные дальше от береговой
линии, чем фронт, отбрасываются. Таким образом кромка воды на берегу совпадает с накатившим фронтом.
\item \b{Смешивание с визуализацией водной поверхности.} В каждом неотброшенном фрагменте результат работы механизма визуализации водной поверхности
смешивался с данными, полученными от эффекта прибрежной пены, и итог полностью перезаписывал 
содержимое g-буфера в позиции, соответствующей фрагменту.
\end{enumerate}

\subsection{Эффект <<Мокрого песка>>}
Эффект мокрого песка работает в целом аналогично эффекту наката волны на берег, только 
вода или пена не визуализируются, а лишь модифицируются сохраненные в g-буфере характеристики
материала ландшафта. Кинематика поведения мокрого песка совпадает с кинематикой наката волны 
до $t = \mathrm{\Delta t} / 2$, когда волна останавливается на берегу. 
После этого момента откат фронта мокрого песка происходит с в несколько раз меньшим ускорением,
чем $a$ наката.

В результате модифицируются такие характеристики материала ландшафта, как: 
альбедо (в сторону уменьшения) и коэффициент зеркального отражения(отражения). 
Данная модификация имеет следующее обоснование: намокшие песчинки, покрываются водной пленкой, и их
диффузное отражающая способность уменьшается, уступая место зеркальной. Эти модификации 
используют уже обсуждавшиеся особенности отложенного освещения.