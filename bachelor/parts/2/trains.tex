\section{Визуализация прибоя}\label{trains}
Эффект прибоя возникает из-за того, что на мелководье волны становятся чувствительны к небольшим
изменениям в форме дна, которые с разной задержкой влияют на нижние и верхние водные слои. Как правило
нижние слои замедляются относительно верхних и гребень волну рушиться. 

Бурление воды на фронтах рушащихся волн напрямую приводит к образованию прибрежной пены, 
которая растягивается вслед за данными фронтами (см.~\ref{fig_shoreline_example}). Для создания 
схожего визуального эффекта на всей площади эффекта генерируется некоторое множество рушащихся
волновых фронтов, движущихся по направлению к берегу. Далее для каждой точки на площади эффекта
определяется, какой фронт и в какой момент последний раз проходил через эту точку и основываясь
на этой информации далее восстановить: какое количество пены осталось к данному моменту в данной точке, 
лежит ли эта точка на обрушивающейся в данный момент волне. 

\drawfigurex{H}{width=10cm}{pics/shoreline.eps}{Фотография мексиканского побережья, на которой
хорошо выделяются фронты рушащихся волн и пена вслед за ними.}{fig_shoreline_example}

\subsection{Базовая схема генерации прибоя}
Водное пространство от $\xi_y = y_\mathrm{min}$ до $\xi_y = y_\mathrm{max}$ 
разделено на непересекающиеся полосы. При этом пена, порожденная в одной полосе обязательно
исчезает внутри той же самой полосы. Таким образом для того, чтобы узнать какой фронт мог последний раз
породить пену в данной точке $\bvec{x} = (x, y)$ достаточно проверить только те фронты, которые находятся внутри полосы, 
проходящей через $\bvec{x}$. Для того, чтобы получить некоторый идентификатор 
$\mathrm{tid}$ этой полосы используется следующая формула:
\begin{equation}
\mathrm{tid} = \left\lfloor \frac{\xi_y(\bvec{x}) + vt}{d} \right\rfloor,
\end{equation}
где $v$ --- скорость движение волновых фронтов, $t$ --- текущее время, а $d$ --- ширина полосы. 

Внутри полосы множество точек $\xi_x = a_x$ ($a_x$ --- любое) пересекается единственным фронтом
в некоторой точке $(a_x,a_y)$ в береговой системы координат, а также интенсивность $\gamma$ 
<<бурления>> в данной точке (к краям обрушивающегося фронта это значение уменьшается). 
Зная текущее положение фронта и считая, что фронт перемещается вдоль $\xi_x = const$ 
и скорость $v$ фронта можно восстановить время $\mathrm{\Delta t}$, прошедшее с того момента, 
когда пена появилась в данной точке в последний раз. Значение $a_y$ может быть не определено,
тогда считается, что рушащийся фронт пересекал множество $\xi_x = a_x$ достаточно давно, чтобы
любые его воздействия стали неразличимы. Данная схема проиллюстрирована на рис.~\ref{fig_front_gen}.

\drawfigure{pics/front_gen.eps}{Схематичное изображение метода генерации фронта}{fig_front_gen}:

\subsection{Генерация формы волнового фронта}
Данный подраздел решает задачи вычисления $a_y(\xi_x)$ и $\gamma(\xi_x)$, 
там где они определены, и сигнализация о неопределенности того или иного значения внутри данной полосы
при данном $\xi_x$. 

\subsubsection{Функция положения фронта}
Для того, чтобы определить, где на множестве $\xi_x$ расположены фронты волн, гребни 
которых обрушиваются в данный момент, генерируется несколько вариантов кусочно-постоянной функции 
$g$, определенной на отрезке $[0,1]$, множеством значений которой являются данные о поведении 
фронта либо некоторое значение, сигнализирующее о неопределенности функции. 

Итак, случайным образом выделим на отрезке $[0,1]$ непересекающиеся отрезки, в которых сохраним 
следующую информацию о самих отрезках и некоторую вспомогательную информацию о поведении фронта.
Пусть $i$-ым отрезком является $[a_i,b_i]$, тогда значения функции в каждой точке на этом отрезке 
равны между собой и имеют следующую структуру:
\begin{itemize}
\item $g_c(v) = (a_i + b_i) / 2 $ --- координаты центра отрезка;
\item $g_o(v)$ --- расстояние от нижней (меньшего $\xi_y$) границы полосы до фронта;
\item $g_w(v) = b_i - a_i$ --- ширина фронта;
\item $g_s(v)$ --- координата $\xi_y$ появления фронта.
\end{itemize}
Значение функции вне отрезков будем обозначать как $\mathrm{null}$.

\subsubsection{Шум}
Волновые фронты не повторяют собой форму береговой линии, а имеют неровности в своей структуре,
вызванные неоднородностью дна. Поэтому для усиления реалистичности функция $a_y(\xi_x)$ 
использует функции от двух аргументов $\mathrm{noise}_\mathrm{lf}(u, v)$ и $\mathrm{noise}_\mathrm{hf}(u, v)$, 
представляющие  собой низкочастотный и высокочастотный непрерывные шумы. В данной работе 
использовался непрерывный шум на основе шума Перлина (англ.~Perlin noise), пример генерации 
и использования которого можно найти в \cite{texturing}.

\subsubsection{Функции фронта}
Имея доступ к функции $g$ значение функции $a_y(a_x)$ для полосы $\xi_y \in [y_{min},
y_{max}]$ вычисляется используя следующее преобразование координаты $\xi_x$: 
выбирается некоторая величина $L$, которая равна расстоянию, на которое <<растягивается>>
функция $g$ вдоль $\xi_y = \mathrm{const}$; затем, в качестве аргумента к $g$, 
используется следующая величина: $\mathrm{u} = \mathrm{fract}(\xi_x / L)$, где:
$$
    \mathrm{fract}(x) = x - \lfloor x \rfloor.
$$

Результирующая формула, при условии, что $g(u) \neq \mathrm{null}$:
\begin{equation}
a_y(\xi_x) = 
    y_\mathrm{min} - g_o(u) - \mathrm{noise}_\mathrm{lf}(\xi_x, v_\mathrm{lf} t) - \mathrm{noise}_\mathrm{hf}(\xi_x, v_\mathrm{hf} t),
\end{equation}
где $v_\mathrm{lf}$ и $v_\mathrm{hf}$ --- это скорость анимации низкочастотного и высокочастотного
шума соответственно, а $t$ --- текущее время.

Выражение для $\gamma(\xi_x)$ имеет следующий вид:
\begin{equation}
    \gamma(\xi_x) = 
        \beta(0.5 g_w(u) L, |u - g_c(u)|) g_w(u) L \mathrm{clamp}\left( \left(\frac{\xi_y - g_s(u)}{l_\mathrm{grow}} \right)^2 \right)
\end{equation}
где $l_\mathrm{grow}$ --- расстояние, которое фронт должен пройти, прежде чем достигнуть 
максимальной ширины, $\beta(a, b)$ --- монотонная функция, равная единице, при $b = 0$, и нулю, при $b = a$,
задача которой уменьшить интенсивность бурления фронта к его краю. 
$$
    \mathrm{clamp}(x) = \max(0, \min(1, x))
$$

\subsection{Визуализация пены}
Вычислив значения $a_y$ и $\gamma$ можно различным образом определить интенсивность пены и 
бурления в конкретной точке. В данной работе интенсивность пены определялась следующим образом:
сначала, на основании $\gamma$ вычислялось время жизни пены $\mathrm{\delta t}$, а затем, используя $a_y$, $\xi_y$ 
и скорость $v$ движения волнового фронта время, интенсивность вычислялась, как: $\alpha = \phi(\mathrm{clamp}((a_y - \xi_y) / \mathrm{\delta t}))$, где 
$\phi$ --- некоторая монотонная функция, определенная на интервале $[0, 1]$, такая, что
$\phi(0)=1$, а $\phi(1) = 0$.

\subsubsection{Текстурирование}
Для реалистичной визуализации пены использовались две текстуры пены, прокручивающиеся под
слегка отличающимися углами в направлении возрастания $\xi_y$ и накладывающиеся друг на друга.
Непрозрачность $\alpha_\xi$ полученная из текстур модифицировалась следующим образом:
\begin{equation}
\tilde\alpha = \mathrm{clamp}\left(\frac{\alpha_\xi - \alpha}{\alpha} \right).
\end{equation}
Данная модификация позволяет реалистичнее визуализировать проявление/исчезание пены.
Цвет, полученный из текстуры с коэффициентом $\tilde\alpha$ смешивается с текущим значением
диффузного отражения в G-буфере

\subsubsection{Другие модификации G-буфера}
Поверхность воды, покрытая пеной теряет свою зеркальность. Данный эффект был реализован с помощью
умножения коэффициента зеркального отражения, сохраненного в G-буфере, на некоторую константу
$c \in [0,1]$, зависящую от $\tilde\alpha$.