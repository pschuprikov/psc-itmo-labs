\section{Визуализация прибоя}

\subsection{Объемные декалы}
Для наложения всех трех, обозначенных в постановке задачи эффектов используется техника, известная
как \emph{объемные декалы} (англ.~volume decals). Пример применения можно найти в \cite{volume}.
Данный метод наложить новые данные поверх уже отрисованной поверхности. Для этого ищется ограничивающий 
параллелепипед, включающий в себя участок поверхности, на которые требуется наложить некоторый эффект.
Затем данный параллелепипед отправляется на отрисовку с выключенным тестом глубины. Во фрагментном шейдере
определяется позиция в мировой системе координат уже отрисованной точки, ранее попавшей в этот же фрагмент,
для чего используется уже записанное в буфер глубины значение этой самой глубины, которое определяется 
как:
\begin{equation}
z_w = \frac{z_c(f - n)}{2w_c} + \frac{n + f}{2},
\end{equation}
где $f$ --- это дальняя плоскость пирамиды видимости, $n$ --- ближняя плоскость, а $z_c$ b $w_c$ ---
однородные координаты, полученные после преобразования проекции. Отсюда, зная сохраненное значение $z_w$
восстанавливается значение $z_c$, после чего преобразование, обратное к используемому при визуализации,
позволит восстановить положение уже отрисованной точки в мировой системе координат.

Обычно на следующем шаге проверяется: попала ли точка в область, на которую требуется наложить эффект или нет
(в частности проверяется: попала ли точка в ограничивающий параллелепипед). После этого по 
позиции в мировой системе координат вычисляются параметры эффекта и затем модифицируются значения в G
-буфере.

Описанные в предыдущем разделе методы интерполяции береговых координат применяются следующим образом:
\begin{enumerate}
\item Полученные на этапе предварительной обработки вершинные данные (в частности $(x_c, y_c)$ и 
$\mathbf{p'}$) трапеций отправляются на отрисовку.
\item Геометрический шейдер выдавливает плоские трапеции по высоте так, чтобы они преобразовались в 
прямоугольные призмы и закрыли собой всю водную поверхность. 
\item Восстанавливается исходное положение фрагментов уже отрисованной воды в мировой системе координат.
\item Используя данные предыдущего шага во фрагмент интерполируется значение $(x_c, y_c)$.
\end{enumerate}

\subsection{Генерация фронтов прибоя}
Задачу, решение которой будет описано в данном подразделе, сгенерировать 
фронты прибоя таким образом, чтобы в их расположении нельзя было разглядеть 
какого-то нижележащего шаблона. Основная опасность исходит от изолиний $y_c = \mathrm{const}$, потому 
как они представляют собой основную закономерность в параметрах эффекта.

Во-первых водное пространство от $y_c = 0$ до $y_c = y_\mathrm{max}$ было поделено на непересекающиеся 
полосы, каждая из которых использовала свой собственный шум, и идентифицировалась параметром $\mathrm{tid}$.
Полосы перемещались во времени, с помощью добавки вида $vt$ к $y_c$, где $v$ --- скорость фронта,
$t$ --- время виртуальной реальности.

Затем по $\mathrm{tid}$ волновой фронт идентифицировал соответствующую ему одномерную текстуру 
$\mathrm{front}$, которая на всем своем пространстве $[0,1]$ содержала несколько непересекающихся
случайно сгенерированных отрезков, каждый из которых соответствовал отдельному фронту прибоя и содержал
следующую информацию:
\begin{itemize}
\item $\mathrm{center}$ --- позиция центра фронта относительно $[0,1]$ текстурных координат;
\item $\mathrm{offset}$ --- отступ от края полосы до фронта;
\item $\mathrm{width}$ --- ширина фронта относительно $[0,1]$ текстурных координат;
\item $\mathrm{start}$ --- отступ от берега, на котором фронт должен появиться.
\end{itemize}

Параметры генерации данной информации настраиваются внешним образом и позволяют контролировать
среднюю ширину фронта, расстояние между фронтами и время появления фронтов.

Для того, чтобы придать фронту ощущение движения, используя $\mathrm{tid}$ и некоторый сдвиг по времени
сдвиг относительно начала полосы модифицируется двумя другими 
(отличающимися частотой и силой шума) шумовыми периодическими текстурами.

Экспериментально оказалось, что только лишь предыдущего шума недостаточно, потому как из-за 
непредсказуемого отражения координат либо появляются дыры, либо (если сделать шум достаточно частым) 
становятся заметны полосы. Потому был сгенерирован шашечный паттерн, который накладывался поверх
предыдущего шума и имел параметрами $\mathrm{tid}$ и номер грани скелетона, из которого была
получена текущая трапеция. Полученный паттерн уже был не подвержен отражению текстурных координат.

\subsection{Визуализация пены}
По информацию предыдущего подраздела для любой точки внутри полосы легко можно было узнать, какое
время назад фронт находился в данной точке. На основании данной информации выбиралась интенсивность
пены. Пена представляет собой текстуру, наложенную по координатам $(x_c, y_c)$ под двумя разными углами
и прокручивающаяся по направлению к берегу.

Отражающая способность значительно отличается от отражающей способности водной поверхности, поэтому
в G-буфере были модифицированы данные об альбедо материала и уменьшена <<зеркальность>>.
