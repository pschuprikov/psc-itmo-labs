\section{Метод проекции на буфер глубины}\label{volume_decals}

В предыдущем разделе была построена некоторая система береговых координат, зависящая от мировых 
координат $(x,y)$ и не зависящая от высоты, на основе которой предлагается реализовать требуемые эффекты.
Эффекты, таким образом, получаются двухмерные. В качестве метода, которой позволил бы визуализировать 
данные эффекты поверх уже отрисованных водной поверхности и ландшафта, был выбран метод
\emph{проекции на буфер глубины}. Пример и подробности о применении данного метода 
можно найти в статье \cite{volume}.

В качестве главных достоинств метода проекции на буфер глубины выделены следующие:
\begin{itemize}
\item малые требования к объему вспомогательных данных, достаточно только грубого приближения
геометрии включающей зону эффекта;
\item метод не требует вмешательства в механизм визуализации водной поверхности и ландшафта;
\item независимость от расстояния до наблюдателя;
\item простота реализации;
\item гибкость, хорошо подходит для отложенного освещения.
\end{itemize}
Решающими были первый и второй пункты, в то время как в качестве альтернативы рассматривался метод,
который заполнял бы некоторую ортографическую карту эффектов, которая затем использовалась в
процессе визуализации водной поверхности и ландшафта и нужным для эффекта образом модифицировала этот
процесс. Такие недостатки данного и подобных методов, как:
\begin{itemize}
\item зависимость от расстояния до наблюдателя;
\item требуется память для хранения карты эффекта, пропорциональная площади эффекта;
\item необходима модификация существующих механизмов визуализации,
\end{itemize}
сделали эти методы неприемлемыми для решения поставленной задачи.

\subsection{Схема метода}
Итак, основой метода проекции на буфер глубины являются некоторые особенности графического конвейера,
которые могут несколько отличаться от одной библиотеке к другой, здесь и далее мы будем говорить
о некоторой реализации спецификации \emph{OpenGL} \cite{glspec}.

Точка $(x, y, z, 1)$ в четырехмерном однородном пространстве в мировой системе координат 
преобразуется в процессе работы графического конвейера следующим образом:
c помощью предоставленных матрицы преобразования из мировых координат в систему координат камеры
$\mathbf{C}$ и матрицы проекции $\mathbf{P}$ точка переводиться в систему координат устройства, а затем
систему координат окна:
\begin{equation}\label{gltransforms}
\begin{array}{c}
    (x_c, y_c, z_c, w_c) = P C \bvec{x}\\
    (x_d, y_d, z_d) = \left(\frac{x_c}{w_c}, \frac{y_c}{w_c}, \frac{z_c}{w_c} \right) \\
    (x_w, y_w, z_w) = \left(\frac{p_x}{2}x_d + o_x, \frac{p_y}{2}y_d + o_y, \frac{f - n}{2}z_d + \frac{n + f}{2} \right)
\end{array}
\end{equation}
где $(p_x, p_y)$ --- размеры окна в пикселях, $(o_x, o_y)$ --- координаты центра окна в пикселях,
$n$ и $f$ --- расстояние до ближней и дальней плоскости пирамиды видимости соответственно.

Величина $z_w$ для каждого пикселя окна сохраняется в специальный массив называемый буфером глубины,
а координаты $x_w$ и $y_w$ предоставляются графической библиотекой.
Идея метода состоит в следующем: на визуализацию графическому конвейеру отправляется некоторая геометрия
с той лишь целью, чтобы породить как минимум один фрагмент на каждый пиксель выходного изображения, который
может оказаться покрыт эффектом. Затем, используя сохраненную глубину и информацию о пирамиде видимости
($n$ и $f$), зная координаты $x_c$ и $y_c$, которые однозначно можно восстановить использовав также 
известные величин  $x_w$ и $y_w$ и $z_c$, можно восстановить исходные координаты $(x, y, z, 1)$.
Формулы для этого легко получить, обратив (\ref{gltransforms}). 

Далее фрагментный шейдер заполняет выходные буферы, смешивая (англ.~blending) данные эффекта и данных уже 
отрисованных водной поверхности или ландшафта, используя встроенные возможности \emph{OpenGL}.


В качестве недостатков метода можно выделить: дополнительную нагрузку на подсистему графической памяти
в связи с необходимостью чтения из буфера глубины, а также лишние вычисления во фрагментах, 
которые на самом деле не содержат эффекта, а появились лишь из приближенного характера геометрии.

\subsection{Детали использования метода}
Применение метода проекции на буфер глубины в данной работе обладает двумя особенностями: во-первых, 
специфичный для любого применения данного метода вид геометрии, которая должна породить все необходимые фрагменты
и при этом порождать минимальное количество лишних; во-вторых, использование техники отложенного освещения,
которая открывает дополнительные возможности применения метода проекции на буфер глубины.

\subsubsection{Покрывающая геометрия}
В качестве покрывающей геометрии выступало разбиение кусочно-линейного скелета, определенное в
предыдущем разделе, расширенное третьим измерением (высотой) так, чтобы вся поверхность, на которой 
может возникнуть эффект оказалась внутри прямоугольных призм, основанием которых является трапеция
или треугольник разбиения. 

В предыдущем разделе также был приведен критерий, которому должна соответствовать точка $(x,y)$, чтобы
находиться внутри элемента разбиения. Используя данный критерий каждая призма должна пропускать на отрисовку 
только те фрагменты, которые лежат внутри соответствующих элементов разбиения, поскольку на месте
одного и того же пикселя будет отрисовано несколько фрагментов, что в результате смешивания приведет
к появлению нежелательных артефактов визуализации.

Другие особенности покрывающей геометрии можно найти в подразделе \ref{impl_volume_decals}.

\subsubsection{Использование отложенного освещения}
Наличие отложенного освещения позволяет, не реализуя отдельных логик для вычисления освещенности
фрагмента, модифицировать характеристики материала объекта, породившего фрагмент, (например,
диффузное отражение, нормаль к поверхности, зеркальное отражение и другие) и получить более реалистичный 
эффект. Это достигается настройкой смешивания соответствующих характеристик эффекта и 
существующего материала внутри g-буфера. К примеру, подобная техника была использована в работе
\cite{warhammer}, в частности, использовалась модификация нормалей, для придания проекциям объемности.